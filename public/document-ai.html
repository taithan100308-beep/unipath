<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unipath AI Chat</title>
  <style>
    :root {
      --blue: #1e88e5;
      --light-blue: #e3f2fd;
      --gray: #f5f5f5;
      --text: #222;
    }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: white;
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: var(--blue);
      color: white;
      padding: 1rem 2rem;
      font-size: 1.4rem;
      font-weight: 600;
      text-align: center;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: var(--gray);
    }

    .message {
      max-width: 70%;
      padding: 1rem;
      border-radius: 1rem;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .user {
      align-self: flex-end;
      background: var(--blue);
      color: white;
      border-bottom-right-radius: 0;
    }

    .bot {
      align-self: flex-start;
      background: var(--light-blue);
      color: #000;
      border-bottom-left-radius: 0;
    }

    .input-area {
      display: flex;
      border-top: 1px solid #ddd;
      padding: 1rem;
      background: white;
    }

    .input-area input {
      flex: 1;
      padding: 0.8rem 1rem;
      border: 1px solid #ccc;
      border-radius: 1rem;
      outline: none;
      font-size: 1rem;
    }

    .input-area button {
      background: var(--blue);
      border: none;
      color: white;
      margin-left: 0.5rem;
      border-radius: 1rem;
      padding: 0 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.3s;
    }

    .input-area button:hover {
      background: #1565c0;
    }

    /* ‚è≥ Hi·ªáu ·ª©ng g√µ ch·ªØ */
    @keyframes blink {
      0% { opacity: 0.2; }
      20% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    .loading-dots span {
      animation: blink 1.4s infinite both;
    }
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
  </style>
</head>
<body>
  <header>üí¨ Unipath AI Chat</header>

  <div class="chat-container" id="chat">
    <div class="message bot">Xin ch√†o! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa Unipath ü§ñ<br>B·∫°n mu·ªën h·ªèi g√¨ v·ªÅ c√¥ng vƒÉn ho·∫∑c tuy·ªÉn sinh h√¥m nay?</div>
  </div>

  <div class="input-area">
    <input type="text" id="userInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." />
    <button onclick="sendMessage()">G·ª≠i</button>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");

    // üóÇÔ∏è Danh s√°ch c√¥ng vƒÉn
    const documents = [
      {
        id: "cv1",
        title: "C√¥ng vƒÉn 123/UBND - Tuy·ªÉn sinh ƒë·∫°i h·ªçc",
        text: `
C√¥ng vƒÉn 123/UBND ng√†y 20/5/2024: 
Th√≠ sinh c√≥ ch·ª©ng ch·ªâ IELTS t·ª´ 6.0 tr·ªü l√™n ƒë∆∞·ª£c ph√©p x√©t tuy·ªÉn v√†o c√°c ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o ch·∫•t l∆∞·ª£ng cao.
K·ª≥ thi t·ªët nghi·ªáp THPT qu·ªëc gia nƒÉm 2025 d·ª± ki·∫øn t·ªï ch·ª©c v√†o cu·ªëi th√°ng 6.
C√°c tr∆∞·ªùng ƒë·∫°i h·ªçc c√≥ th·ªÉ s·ª≠ d·ª•ng k·∫øt qu·∫£ k·ª≥ thi n√†y ƒë·ªÉ x√©t tuy·ªÉn sinh vi√™n theo ph∆∞∆°ng th·ª©c ƒëi·ªÉm thi ho·∫∑c k·∫øt h·ª£p ch·ª©ng ch·ªâ qu·ªëc t·∫ø.
        `
      },
      {
        id: "cv2",
        title: "C√¥ng vƒÉn 456/BGDƒêT - H·ªçc b·ªïng v√† h·ªó tr·ª£ sinh vi√™n",
        text: `
C√¥ng vƒÉn 456/BGDƒêT ng√†y 2/7/2024: 
Sinh vi√™n thu·ªôc h·ªô ngh√®o, c·∫≠n ngh√®o, v√πng s√¢u v√πng xa ƒë∆∞·ª£c xem x√©t c·∫•p h·ªçc b·ªïng khuy·∫øn kh√≠ch h·ªçc t·∫≠p.
H·ªçc sinh ƒë·∫°t gi·∫£i qu·ªëc gia ho·∫∑c qu·ªëc t·∫ø ƒë∆∞·ª£c mi·ªÖn h·ªçc ph√≠ nƒÉm ƒë·∫ßu.
        `
      },
      {
        id: "cv3",
        title: "C√¥ng vƒÉn 789/UBND - Quy ƒë·ªãnh thi THPT",
        text: `
C√¥ng vƒÉn 789/UBND ng√†y 15/4/2024:
K·ª≥ thi t·ªët nghi·ªáp THPT nƒÉm 2025 s·∫Ω di·ªÖn ra trong 3 ng√†y, g·ªìm c√°c m√¥n: To√°n, Ng·ªØ vƒÉn, Ngo·∫°i ng·ªØ, Khoa h·ªçc t·ª± nhi√™n, Khoa h·ªçc x√£ h·ªôi.
ƒêi·ªÉm thi s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë ch·∫≠m nh·∫•t 10 ng√†y sau khi k·∫øt th√∫c k·ª≥ thi.
        `
      }
    ];

    // üìö H√†m t√¨m c√¥ng vƒÉn ph√π h·ª£p nh·∫•t
    function findBestMatch(question) {
      const lowerQ = question.toLowerCase();
      let best = documents[0];
      let score = 0;

      for (const doc of documents) {
        const matches = doc.text
          .toLowerCase()
          .split(/\s+/)
          .filter(word => lowerQ.includes(word)).length;
        if (matches > score) {
          score = matches;
          best = doc;
        }
      }
      return { best, score };
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      // üßç‚Äç‚ôÇÔ∏è Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
      const userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.textContent = text;
      chat.appendChild(userMsg);
      input.value = "";
      chat.scrollTop = chat.scrollHeight;

      // ü§ñ Hi·ªÉn th·ªã bot ƒëang x·ª≠ l√Ω
      const botMsg = document.createElement("div");
      botMsg.className = "message bot loading-dots";
      botMsg.innerHTML = "‚è≥ ƒêang x·ª≠ l√Ω<span>.</span><span>.</span><span>.</span>";
      chat.appendChild(botMsg);
      chat.scrollTop = chat.scrollHeight;

      // üîç T√¨m c√¥ng vƒÉn li√™n quan nh·∫•t
      const { best: chosen, score } = findBestMatch(text);

      // ‚ùå N·∫øu kh√¥ng li√™n quan ƒë·ªß (√≠t t·ª´ tr√πng)
      if (score < 5) {
        botMsg.classList.remove("loading-dots");
        botMsg.textContent =
          "ü§ñ Xin l·ªói, m√¨nh ch·ªâ c√≥ th·ªÉ h·ªó tr·ª£ c√°c c√¢u h·ªèi li√™n quan ƒë·∫øn c√¥ng vƒÉn ho·∫∑c tuy·ªÉn sinh th√¥i nha üòä\n" +
          "üëâ B·∫°n c√≥ th·ªÉ h·ªèi m√¨nh v·ªÅ: th·ªùi gian thi, ƒëi·ªÅu ki·ªán x√©t tuy·ªÉn, ch·ª©ng ch·ªâ IELTS, h·ªçc b·ªïng, ho·∫∑c quy ƒë·ªãnh thi c·ª≠!";
        chat.scrollTop = chat.scrollHeight;
        return;
      }

      // üöÄ G·ª≠i request ƒë·∫øn Cloud Function
      try {
        const base =
          location.hostname === "localhost" || location.hostname === "127.0.0.1"
            ? "http://127.0.0.1:5001/study-56c0a/us-central1"
            : "";
        const url = base ? `${base}/chatWithAI` : "/api/chat";

        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text }),
        });

        if (!res.ok) throw new Error(`Server responded with ${res.status}`);

        const data = await res.json();
        botMsg.classList.remove("loading-dots");
        botMsg.textContent = `üìÑ (${chosen.title})\n${data.reply || "Xin l·ªói, m√¨nh ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi."}`;
      } catch (err) {
        console.error("‚ùå L·ªói khi g·ªçi API:", err);
        botMsg.classList.remove("loading-dots");
        botMsg.textContent = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi server.";
      }

      chat.scrollTop = chat.scrollHeight;
    }

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>